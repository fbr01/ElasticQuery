<html>
<head>
<title>ElasticQuery</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
<style>
body{font-family:arial;font-size: 9pt;}
#metadata {width:9em;height:30em;padding:0px;}
#toolbar  {position: absolute;top: 1em;left: 13em;width:55em;height:4em; }
#result   {position: absolute;top: 6em;left: 12em;width:60em;height:42em;}
#tabs-1{height:35em;overflow:auto;}
#db_fields, #view_fields { 
padding: 8 4 2em;
background-color: rgb(245, 245, 245);
border: 1px solid rgb(227, 227, 227);
border-radius: 4px;
box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.05) inset;
list-style-type: none;
}

#db_fields {height:30em;width : 11em;}
#view_fields {width : 46em;}
#db_fields li, #view_fields li { margin: 0 5px 5px 5px; padding: 5px; font-size: 0.9em; width: 110px; }
#view_fields li { display:inline;}

#worksheet {
font-family:arial;
background-color: #CDCDCD;
margin:10px 1pt 15px;
font-size: 9pt;
text-align: left;
max-height: 330px;
overflow:auto;
}

#worksheet th, #worksheet th {
background-color: #CDCDCD;
font-size: 10pt;
padding: 4px;
text-align:center;
}

#worksheet tr:nth-child(even) {
background-color: #EEEEEE;
}

#worksheet tr:nth-child(odd) {
background-color: #FFFFFF;
}

select, input, textarea {
display: block;
padding: 6px 12px;
line-height: 1.42857;
color: rgb(85, 85, 85);
vertical-align: middle;
background-color: rgb(255, 255, 255);
background-image: none;
border: 1px solid rgb(204, 204, 204);
border-radius: 4px;
box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.075) inset;
transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
}

#es_indexs{
position: absolute;top: 1em;
width: 12em;
height: 34px;
}

#db_fields{
position: absolute;top: 5em;
}

#csv{
width:45em;
height: 330px;
}

#csvbutton{
position: absolute;
left: 50em;
top : 2em;
color: rgb(255, 255, 255);
background-color: rgb(71, 164, 71);
border-color: rgb(57, 132, 57);
border-radius: 4px;
box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.075) inset;
transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
}
</style>
<script>
//Utility fonctions
$.urlParam = function(name){
    var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results==null){
       return null;
    }
    else{
       return results[1] || 0;
    }
}


/*
* Configuration *****
*/
var elasticsearch_url = 'http://'+window.location.hostname+':9200';
var date_format = 'dd/mm/yy';
/*
* *******************
*/


var data = [];
var selected_es_index = $.urlParam('es_index');
var available_es_fields = [];
var selected_es_fields = [];

//Populate indexs/DB selection
$.ajax({
  url: elasticsearch_url+'/_aliases?pretty=1',
  dataType: 'jsonp',
    success: function( json ) {
	var data = json;
        $.each(data, function(field) {
            $('#es_index').append($('<option>').text(field).attr('value', field));
        });
	if (selected_es_index != undefined){
		$("#es_index").val(selected_es_index);
	}
    }
});

//Populate selected index/DB available fields
if (selected_es_index != undefined){
	$.ajax({
	  url: elasticsearch_url+'/'+selected_es_index+'/_mapping?pretty=1',
	  dataType: 'jsonp',
	    success: function( json ) {
		$(jQuery.parseJSON(JSON.stringify(json))).each(function() {  //Index
			$.each(this, function(index) { //Index
				$.each(this, function(doctype) { //Doctype
					$.each(this, function(properties) { //properties
						$.each(this, function(rootTag) { //rootTag
							if(available_es_fields[rootTag] == undefined){
								available_es_fields[rootTag] = 'ok';
								$("#db_fields").append($('<li class="ui-state-default">').text(rootTag).attr('value', rootTag));
							}
						});
					});
				});
			});
		});

	    }
	});
}

$(document).ready(function() {
	//UI tabs
	$("#result").tabs();

	//Metadatas - Interaction beetwen available db fields and view fields
	$( "#db_fields, #view_fields" ).sortable({
		connectWith: ".connectedSortable",
		stop:function(event,ui){
			refresh_query();
		}
	}).disableSelection();
});

//Refresh DB Query
function refresh_query(){
	selected_es_fields = [];
	$('#view_fields li').each(function(i){
		selected_es_fields[$( this ).text()] = 'ok';
	});
	$('#worksheet').empty();
	$('#csv').empty();

	//Execute query & populate
	$.ajax({
		    url: elasticsearch_url+'/'+selected_es_index+'/_search',
		    type: 'GET',
		    dataType: 'json',
		    data: {
		        query:{"match_all": {}},
		        pretty: true,
			from : 0,
			size : 10000000,//
		    },
		    success: function(response) {
		        var data_response = response.hits.hits;

		        if (data_response.length > 0) {
		            for (var i = 0; i < data_response.length; i++) {
				data[i] = data_response[i]._source;
				if (i==0){
					$('#worksheet').append('<thead><tr>');
					$.each(data_response[i]._source, function(field,value) {
						if(selected_es_fields[field] != undefined){
							$("#worksheet").append('<th>'+field+'</th>');
							$('#csv').append(field+';');
						}
					});
					$('#worksheet').append('</tr></thead>');
				}
				$('#worksheet').append('<tr id="_id'+data_response[i]._id+'">');
				$('#csv').append('\n');
				$.each(data_response[i]._source, function(field,value) {
					if(selected_es_fields[field] != undefined){
						if (field.indexOf("date") !=-1){
							value = $.datepicker.formatDate(date_format, new Date(value));
						}
						$("#_id"+data_response[i]._id).append('<td>'+value+'</td>');
						$('#csv').append(value+';');
					}
				});
				$('#worksheet').append('</tr>');
		            }
		        } else {
				alert('no result');
		        }
		    }
        });
}

</script>


</head>
<body>
<div id="metadata">

<form id="es_indexs" method="GET" ACTION="" onChange="submit()">
ElasticSearch indexs : <select name="es_index" id="es_index">
<option>---</option>
</select>

</form>

<ul id="db_fields" class="connectedSortable"></ul>

</div>

<div id="toolbar">
<ul id="view_fields" class="connectedSortable">
</ul>
<button id="csvbutton" name="CSV" value="CSV" onclick="window.open('data:text/csv,' + $('#csv').val());">CSV</button>
</div>


<div id="result">
 <ul>
<li><a href="#tabs-1">Table</a></li>
<li><a href="#tabs-2">CSV Export</a></li>
<li><a href="#tabs-3">Graphs</a></li>
</ul>
<div id="tabs-1">
<table id="worksheet"></table>



</div>
<div id="tabs-2">
CSV export :
<textarea id="csv"></textarea>
</div>
<div id="tabs-3">




</div>
</div>


</body>
</html>
